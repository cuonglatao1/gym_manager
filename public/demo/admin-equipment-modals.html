<!-- Equipment Details Modal -->
<div id="equipment-details-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>üîß Chi ti·∫øt Thi·∫øt b·ªã</h3>
            <button class="modal-close" onclick="closeModal('equipment-details-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="equipment-details-content">
                <div class="loading">ƒêang t·∫£i th√¥ng tin thi·∫øt b·ªã...</div>
            </div>
        </div>
    </div>
</div>

<!-- Equipment Schedules Modal -->
<div id="equipment-schedules-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3>üìÖ L·ªãch B·∫£o tr√¨ Thi·∫øt b·ªã</h3>
            <button class="modal-close" onclick="closeModal('equipment-schedules-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="equipment-schedules-content">
                <div class="loading">ƒêang t·∫£i l·ªãch b·∫£o tr√¨...</div>
            </div>
        </div>
    </div>
</div>

<!-- Create Maintenance Task Modal -->
<div id="create-task-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üîß T·∫°o C√¥ng vi·ªác B·∫£o tr√¨</h3>
            <button class="modal-close" onclick="closeModal('create-task-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="create-task-form">
                <input type="hidden" id="task-equipment-id">
                
                <div class="form-group">
                    <label>Thi·∫øt b·ªã</label>
                    <input type="text" id="task-equipment-name" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i b·∫£o tr√¨ *</label>
                        <select id="task-maintenance-type" required>
                            <option value="">Ch·ªçn lo·∫°i</option>
                            <option value="daily_clean">V·ªá sinh h√†ng ng√†y</option>
                            <option value="weekly_check">Ki·ªÉm tra h√†ng tu·∫ßn</option>
                            <option value="monthly_maintenance">B·∫£o d∆∞·ª°ng h√†ng th√°ng</option>
                            <option value="repair">S·ª≠a ch·ªØa</option>
                            <option value="replacement">Thay th·∫ø</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>M·ª©c ƒë·ªô ∆∞u ti√™n *</label>
                        <select id="task-priority" required>
                            <option value="medium">Trung b√¨nh</option>
                            <option value="high">Cao</option>
                            <option value="low">Th·∫•p</option>
                            <option value="critical">Kh·∫©n c·∫•p</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y th·ª±c hi·ªán *</label>
                        <input type="date" id="task-scheduled-date" required>
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi gian d·ª± ki·∫øn (ph√∫t)</label>
                        <input type="number" id="task-estimated-duration" min="1" placeholder="30">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ti√™u ƒë·ªÅ *</label>
                    <input type="text" id="task-title" required placeholder="V√≠ d·ª•: B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥ m√°y ch·∫°y">
                </div>
                
                <div class="form-group">
                    <label>M√¥ t·∫£ c√¥ng vi·ªác *</label>
                    <textarea id="task-description" required placeholder="M√¥ t·∫£ chi ti·∫øt c√¥ng vi·ªác c·∫ßn th·ª±c hi·ªán..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ph√¢n c√¥ng cho</label>
                    <select id="task-assigned-to">
                        <option value="">Ch∆∞a ph√¢n c√¥ng</option>
                    </select>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal('create-task-modal')" style="margin-right: 10px;">H·ªßy</button>
                    <button type="submit" class="btn btn-success">üíæ T·∫°o c√¥ng vi·ªác</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Complete Maintenance Modal -->
<div id="complete-maintenance-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚úÖ Ho√†n th√†nh B·∫£o tr√¨</h3>
            <button class="modal-close" onclick="closeModal('complete-maintenance-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="complete-maintenance-form">
                <input type="hidden" id="complete-task-id">
                
                <div class="form-group">
                    <label>C√¥ng vi·ªác</label>
                    <input type="text" id="complete-task-title" readonly style="background: #f8f9fa;">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y ho√†n th√†nh</label>
                        <input type="date" id="complete-performed-date" required>
                    </div>
                    <div class="form-group">
                        <label>Th·ªùi gian th·ª±c t·∫ø (ph√∫t)</label>
                        <input type="number" id="complete-actual-duration" min="1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>C√¥ng vi·ªác ƒë√£ th·ª±c hi·ªán *</label>
                    <textarea id="complete-work-performed" required placeholder="M√¥ t·∫£ chi ti·∫øt nh·ªØng g√¨ ƒë√£ ƒë∆∞·ª£c th·ª±c hi·ªán..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>V·∫•n ƒë·ªÅ ph√°t hi·ªán</label>
                    <textarea id="complete-issues-found" placeholder="C√°c v·∫•n ƒë·ªÅ, h∆∞ h·ªèng ph√°t hi·ªán trong qu√° tr√¨nh b·∫£o tr√¨..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Chi ph√≠ (VNƒê)</label>
                        <input type="number" id="complete-cost" min="0" step="1000" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng</label>
                        <select id="complete-quality-rating">
                            <option value="">Ch·ªçn ƒëi·ªÉm</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê R·∫•t t·ªët</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê T·ªët</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Trung b√¨nh</option>
                            <option value="2">‚≠ê‚≠ê K√©m</option>
                            <option value="1">‚≠ê R·∫•t k√©m</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>T√¨nh tr·∫°ng thi·∫øt b·ªã tr∆∞·ªõc BT</label>
                        <select id="complete-condition-before">
                            <option value="">Ch·ªçn t√¨nh tr·∫°ng</option>
                            <option value="excellent">Xu·∫•t s·∫Øc</option>
                            <option value="good">T·ªët</option>
                            <option value="fair">Kh√°</option>
                            <option value="poor">K√©m</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>T√¨nh tr·∫°ng thi·∫øt b·ªã sau BT *</label>
                        <select id="complete-condition-after" required>
                            <option value="">Ch·ªçn t√¨nh tr·∫°ng</option>
                            <option value="excellent">Xu·∫•t s·∫Øc</option>
                            <option value="good">T·ªët</option>
                            <option value="fair">Kh√°</option>
                            <option value="poor">K√©m</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ghi ch√∫ b·ªï sung</label>
                    <textarea id="complete-notes" placeholder="C√°c ghi ch√∫, khuy·∫øn ngh·ªã cho l·∫ßn b·∫£o tr√¨ ti·∫øp theo..."></textarea>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn" onclick="closeModal('complete-maintenance-modal')" style="margin-right: 10px;">H·ªßy</button>
                    <button type="submit" class="btn btn-success">‚úÖ Ho√†n th√†nh</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- History Details Modal -->
<div id="history-details-modal" class="modal-backdrop" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3>üìù Chi ti·∫øt L·ªãch s·ª≠ B·∫£o tr√¨</h3>
            <button class="modal-close" onclick="closeModal('history-details-modal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="history-details-content">
                <div class="loading">ƒêang t·∫£i chi ti·∫øt l·ªãch s·ª≠...</div>
            </div>
        </div>
    </div>
</div>

<style>
    .detail-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .detail-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
    }
    
    .detail-section h4 {
        margin: 0 0 15px 0;
        color: #495057;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        padding: 5px 0;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
    }
    
    .detail-value {
        color: #212529;
    }
    
    .schedule-list {
        background: #fff;
        border-radius: 8px;
        overflow: hidden;
    }
    
    .schedule-list-item {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .schedule-list-item:last-child {
        border-bottom: none;
    }
    
    .schedule-info {
        flex: 1;
    }
    
    .schedule-title {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .schedule-meta {
        font-size: 0.9em;
        color: #6c757d;
    }
    
    .schedule-actions {
        display: flex;
        gap: 10px;
    }
    
    .text-danger {
        color: #dc3545 !important;
    }
    
    .text-success {
        color: #28a745 !important;
    }
    
    .text-warning {
        color: #ffc107 !important;
    }
    
    .text-muted {
        color: #6c757d !important;
    }
</style>

<script>
// Set today's date as default for task creation
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const scheduledDateInput = document.getElementById('task-scheduled-date');
    const performedDateInput = document.getElementById('complete-performed-date');
    
    if (scheduledDateInput) {
        scheduledDateInput.value = today;
    }
    
    if (performedDateInput) {
        performedDateInput.value = today;
    }
});

// Create task form submission
document.getElementById('create-task-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const formData = {
            equipmentId: parseInt(document.getElementById('task-equipment-id').value),
            maintenanceType: document.getElementById('task-maintenance-type').value,
            priority: document.getElementById('task-priority').value,
            scheduledDate: document.getElementById('task-scheduled-date').value,
            estimatedDuration: document.getElementById('task-estimated-duration').value ? 
                parseInt(document.getElementById('task-estimated-duration').value) : null,
            title: document.getElementById('task-title').value,
            description: document.getElementById('task-description').value,
            assignedTo: document.getElementById('task-assigned-to').value || null
        };

        const response = await apiCall('/api/equipment-maintenance', 'POST', formData);
        
        if (response.success) {
            showSuccess('C√¥ng vi·ªác b·∫£o tr√¨ ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
            closeModal('create-task-modal');
            loadMaintenance();
            
            // Reset form
            document.getElementById('create-task-form').reset();
        } else {
            showError(response.message || 'Kh√¥ng th·ªÉ t·∫°o c√¥ng vi·ªác b·∫£o tr√¨');
        }
    } catch (error) {
        console.error('Error creating maintenance task:', error);
        showError('L·ªói khi t·∫°o c√¥ng vi·ªác b·∫£o tr√¨');
    }
});

// Complete maintenance form submission
document.getElementById('complete-maintenance-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    try {
        const taskId = document.getElementById('complete-task-id').value;
        const formData = {
            workPerformed: document.getElementById('complete-work-performed').value,
            duration: document.getElementById('complete-actual-duration').value ? 
                parseInt(document.getElementById('complete-actual-duration').value) : null,
            cost: document.getElementById('complete-cost').value ? 
                parseFloat(document.getElementById('complete-cost').value) : 0,
            conditionBefore: document.getElementById('complete-condition-before').value,
            conditionAfter: document.getElementById('complete-condition-after').value,
            qualityRating: document.getElementById('complete-quality-rating').value ? 
                parseInt(document.getElementById('complete-quality-rating').value) : null,
            issuesFound: document.getElementById('complete-issues-found').value,
            notes: document.getElementById('complete-notes').value
        };

        const response = await apiCall(`/api/maintenance-scheduler/complete-maintenance/${taskId}`, 'POST', formData);
        
        if (response.success) {
            showSuccess('C√¥ng vi·ªác b·∫£o tr√¨ ƒë√£ ƒë∆∞·ª£c ho√†n th√†nh!');
            closeModal('complete-maintenance-modal');
            loadMaintenance();
            loadDashboard();
            
            // Reset form
            document.getElementById('complete-maintenance-form').reset();
        } else {
            showError(response.message || 'Kh√¥ng th·ªÉ ho√†n th√†nh c√¥ng vi·ªác b·∫£o tr√¨');
        }
    } catch (error) {
        console.error('Error completing maintenance:', error);
        showError('L·ªói khi ho√†n th√†nh c√¥ng vi·ªác b·∫£o tr√¨');
    }
});
</script>